# 第16章 嵌入式系统架构设计理论与实践

- **16.1 嵌入式系统概述**
    - **16.1.1 嵌入式系统的定义及发展**
        - **定义**
            - 嵌入式系统是以应用为中心，以计算机技术为基础，软硬件可裁剪，适应应用系统对功能、可靠性、成本、体积、功耗严格要求的专用计算机系统
        - **特点**
            - **系统专用性强**: 面向特定应用
            - **系统实时性强**: 软硬件设计需保证实时性能
            - **软硬件依赖性强**: 专用性导致对硬件依赖
            - **处理器专用**: 高效、低功耗
            - **多种技术结合**: 计算机、半导体、电子、通信等
            - **系统透明性**: 用户不需要感知底层
            - **环境适应性**: 恶劣环境工作能力
            - **资源受限**: 存储、电源、计算能力有限
        - **发展阶段**
            - 第一阶段: 单片机 (SCM)
            - 第二阶段: 微控制器 (MCU)
            - 第三阶段: 嵌入式DSP
            - 第四阶段: 嵌入式片上系统 (SoC)
        - **分类**
            - 硬件: 芯片级、模块级、系统级
            - 软件/应用: 实时/非实时, 工业控制/消费电子/通信等
    - **16.1.2 嵌入式系统硬件体系结构**
        - **组成**
            - 嵌入式微处理器 (MCU/MPU/DSP/GPU/SoC)
            - 存储器 (RAM/ROM)
            - 内/外总线逻辑
            - 定时/计数器 (Timer), 看门狗 (Watchdog)
            - I/O接口 (串口, 网络, USB, JTAG)
            - 外部设备 (UART, LED等)
        - **处理器分类**
            - **微处理器 (MPU)**: 去除多余外设，高性能，需外接存储和IO，如PowerPC, MIPS, ARM
            - **微控制器 (MCU)**: 单片机，集成度高，体积小，功耗低，如8051, ARM系列
            - **信号处理器 (DSP)**: 哈佛结构，专门处理数字信号算法，编译效率高，如TI TMS320
            - **图形处理器 (GPU)**: 3D图形渲染，减轻CPU负担
            - **片上系统 (SoC)**: 软硬件集成于单一芯片，VHDL描述，高集成度
        - **存储器**
            - **RAM (随机存取存储器)**
                - DRAM (动态): 需刷新，成本低，作主存
                - SRAM (静态): 速度快，无需刷新，作Cache
                - VRAM, FPM DRAM, EDO DRAM, SDRAM, DDR SDRAM等
            - **ROM (只读存储器)**
                - MASK ROM (掩膜): 成本低，无法修改
                - PROM (可编程): 一次写入
                - EPROM (可擦除): 紫外线擦除
                - EEPROM (电可擦除): 电信号擦写
                - Flash Memory (快闪): 在线修改，断电保存，块擦除
        - **总线**
            - **分类**: 片内总线 (CPU内部), 系统总线 (连接CPU/主存/IO), 局部总线 (高速组件间), 通信总线 (外部设备)
            - **常见总线**: PCI, I2C, CAN, VXI, IEEE1394等
        - **I/O接口与外设**
            - 串行/并行接口, DMA, 中断控制器, 定时器, 数模转换等
    - **16.1.3 嵌入式软件架构概述**
        - **发展历程**
            - 早期: 汇编语言，单片机，无OS (监控程序+应用)
            - 中期: 嵌入式实时操作系统 (RTOS), 高级语言，交叉开发
            - 现代: 智能化，构件化，虚拟化，借鉴通用软件架构 (事件驱动, 微服务)
        - **典型架构模式**
            - **层次化模式**: 抽象分层 (如硬件层 -> BSP -> OS -> 应用层)
            - **递归模式**: 复杂系统分解，自顶向下或自底向上
        - **GOA (通用开放式架构)**
            - SAE AS4893标准
            - 目的: 解决开放性、可移植性
            - 特点: 可移植性, 可互操作性, 可剪裁性, 易获得性
            - 接口: 4种直接接口，4种逻辑接口

- **16.2 嵌入式系统软件架构原理与特征**
    - **16.2.1 典型架构模式**
        - **层次化模式架构**
            - 设计思想: 高层抽象依赖低层实现
            - 类型: 封闭型 (只调下层), 开放型 (可调下层及更低层)
            - 优点: 结构清晰; 缺点: 开放型破坏封装但性能好
        - **递归模式架构**
            - 解决问题: 复杂系统分解与扩展
            - 流程: 自顶向下 (标识结构对象), 自底向上 (域构造)
    - **16.2.2 嵌入式操作系统 (EOS)**
        - **定义与特点**
            - 负责软硬件资源分配、任务调度、控制协调
            - **特点**: 可剪裁, 可移植, 强实时, 强紧凑 (代码少), 高质量 (安全攸关), 强定制, 标准接口, 强稳定性/弱交互, 强确定性, 固化运行
        - **分类**
            - 面向控制/通信 (实时, 如VxWorks, Nucleus)
            - 面向消费电子 (非实时, 如Android, iOS)
        - **一般架构**
            - **整体结构 (模块结构)**: 传统结构，应用、OS、BSP紧密结合
            - **BSP (板级支持包)**: 硬件相关驱动
            - **内核**: 任务管理, 内存管理, 通信, 时钟, 中断
            - **可配置库**: GUI, 文件系统, 网络协议栈
        - **内核类型**
            - **宏内核 (Monolithic)**: 内核服务与用户服务在同一空间，耦合高，性能高 (如VxWorks, Linux)
            - **微内核 (Microkernel)**: 内核只含基本功能 (调度/IPC/中断)，服务在用户空间，消息传递，稳定/扩展性好，效率略低 (如QNX, WinCE)
        - **任务管理 (Task Management)**
            - **任务状态**: 执行态, 就绪态, 阻塞态
            - **调度算法**:
                - **抢占式 vs 非抢占式**: 抢占式适合实时系统
                - **静态 vs 动态**: 静态优先级 (运行前确定), 动态优先级 (运行时确定)
                - **EDF (最早截止时间优先)**: 截止时间越早优先级越高 (动态)
                - **LLF (最低松弛度优先)**: 松弛度=必须完成时间-运行时间-当前时间，越小越紧急 (动态)
                - **RMS (单调速率调度)**: 周期越短优先级越高 (静态)
        - **存储管理**
            - **方式**: 分区 (静态/可变), 分页, 分段, 段页式
            - **虚拟存储**: 利用外存扩展内存，局部性原理
                - 功能: 寻址空间扩大, 内存映射, 物理内存共享
            - **对比Table 16-1**: 分页消灭外部碎片但有页表开销；分段便于共享保护但有外部碎片
        - **任务间通信 (IPC)**
            - **方式**: 共享内存 (最快), 信号量 (互斥/同步), 消息队列 (缓冲/灵活), 管道 (Pipe), Socket (网络), Signals (异常/异步)
        - **典型产品**
            - VxWorks (WindRiver), LynxOS, Nucleus, QNX (微内核), Android (移动), iOS, ROS (机器人), HarmonyOS
    - **16.2.3 嵌入式数据库 (EDBS)**
        - **特点**: 嵌入性, 实时性, 移动性, 伸缩性
        - **分类**:
            - **基于内存 (MMDB)**: 实时性好，如eXtremeDB
            - **基于文件 (FDB)**: 磁盘存储，如SQLite, Berkeley DB
            - **基于网络 (NDB)**: 客户端-服务器，移动环境
        - **架构**
            - 不同于通用DB (Server模式)，EDBS通常作为Lib与应用链接在同一进程
            - eXtremeDB: 内存式，对象模型，极小开销
            - SQLite: 轻量级，模块化 (接口->编译器->虚拟机->后端B-tree), Serverless, 单一文件
        - **关键技术**: 内存管理, 安全/完整性, 事务并发控制 (封锁粒度), 实时数据转储, 运行日志 (缓冲区)
    - **16.2.4 嵌入式中间件**
        - **定义**: 处于OS与应用之间，屏蔽异构性
        - **分类**: 消息中间件 (MOM), 分布式对象中间件 (DOM)
        - **通用中间件**: ESB, TP Monitor, RPC, ORB等
        - **嵌入式常用**:
            - **CORBA**: OMG标准，软件总线，对象封装，适合大中型分布式
            - **DDS (Data Distribution Service)**: 针对实时系统，发布/订阅模式，以数据为中心，QoS策略
        - **架构**:
            - 消息中间件: 队列，异步处理，松耦合 (PTP, Pub/Sub)
            - 分布式对象中间件: ORB (软总线), 封装/继承/多态
    - **16.2.5 嵌入式开发环境 (IDE)**
        - **交叉开发 (Cross Development)**: 宿主机 (Host) 开发，目标机 (Target) 运行
        - **工具集**: 编辑器, 编译器 (GCC), 调试器 (GDB), 仿真器 (ICE), 烧录工具
        - **架构**: 基于Eclipse框架 (宿主层, 基本工具层, 应用工具层, 驻留层-Target Agent)
        - **典型环境**: GNU GCC, WindRiver Workbench, GreenHills MULTI

- **16.3 嵌入式系统软件架构设计方法**
    - **设计目标**: 代码逻辑清晰, 可移植, 复用, 高内聚低耦合
    - **16.3.1 基于架构的软件设计 (ABSD)**
        - 自顶向下，递归细化
        - 关注业务、质量和功能需求的组合驱动
        - 强调使用架构模板
    - **16.3.2 属性驱动的设计 (ADD)**
        - **核心**: 将质量属性 (QA) 作为驱动因子
        - **质量场景**: 刺激源, 刺激, 环境, 制品, 响应, 响应度量
        - **开发过程**:
            1. 评审输入 (需求/约束)
            2. 选择驱动因子 (质量属性)
            3. 选择系统元素
            4. 选择设计概念 (模式/策略)
            5. 实例化元素/分配职责/定义接口
            6. 草拟视图
            7. 分析评价
        - **ISO9126**: 软件质量模型
    - **16.3.3 实时系统设计 (DARTS)**
        - **Core**: 将系统分解为并发任务 (Concurrent Tasks)
        - **基础**: RTSAD (实时结构化分析与设计)
        - **步骤**:
            1. RTSA分析 (数据流/控制流)
            2. 划分并发任务 (IO任务, 控制任务等)
            3. 定义任务接口 (消息, 事件, IHM-信息隐藏模块)
            4. 设计每个任务 (结构化设计)
        - **优点**: 强调并发, 提供接口定义指南

- **16.4 嵌入式系统软件架构案例分析**
    - **16.4.1 鸿蒙操作系统 (HarmonyOS)**
        - **定位**: 面向全场景、分布式、微内核
        - **架构层次**:
            - **应用层**: FA/PA (Feature/Particle Ability)
            - **框架层**: 多语言API
            - **系统服务层**: 分布式软总线, 数据管理, 任务调度
            - **内核层**: 多内核设计 (Linux/LiteOS), HDF驱动框架
        - **关键特性**:
            - 分布式软总线: 跨终端无缝协同
            - 确定时延引擎: 高性能IPC, 实时调度
            - 微内核: TEE形式化验证, 高安全
            - 统一IDE: 一次开发, 多端部署
    - **16.4.2 GENESYS架构**
        - **背景**: 欧洲ARTEMIS, 跨领域通用嵌入式平台
        - **挑战**: 复杂性, 健壮性, 能量有效性
        - **架构风格**: “腰”型架构 (核心服务 + 选择服务)
        - **服务分类**:
            - 领域无关: 核心 (时间/消息), 选择 (安全/存储)
            - 领域专用: DSC (CAN总线), DSO
        - **构件模型**: 每个构件包含LIF (Link Interface), 分离计算与通信
        - **特征**: 精确构件定位, 开放性, 三级集成 (芯片/设备/系统), 确定性行为
    - **16.4.3 物联网操作系统**
        - **概念**: “泛化”的嵌入式系统，连接万物
        - **FreeRTOS案例**:
            - 架构: BSP + 核心 (调度/内存) + 组件 (TCP/TLS/MQTT)
            - 特点: 开源, 轻量级, AWS托管
        - **IoT OS特征**: 内核可伸缩, 强实时, 高可靠, 低功耗 (休眠/降频)
